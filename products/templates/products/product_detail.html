{% extends 'base.html' %}
{% load static %}
{% block content_main %}
  <div class="page-title-container">
    <h1 class="page-title">Detailed view of {{ product.name }}</h1>
    <p class="page-subtitle">which is in the category of {{ product.category.friendly_name }}</p>
  </div>
  <div class="product-detail-container">
    <div class="product-detail-container-header">
      {% if product.productimage_set.exists %}
        <img src="{{ product.productimage_set.first.image.url }}" alt="{{ product.name }}" class="product-detail-image" />
      {% else %}
        <img src="{% static 'assets/img/no-clothes-picture.jpg' %}" alt="{{ product.name }}" class="product-detail-image" />
      {% endif %}
    </div>
    <div class="product-detail-section">
      <p>Price: £{{ product.price }}</p>

      {% if product.is_on_sale == True %}
        <p>Sale Price: £{{ product.sale_price }}</p>
      {% endif %}
      <p>Description: {{ product.description }}</p>

      <p>
        Size:{% if product.size %}
          {{ product.size }}
        {% else %}
          N/A
        {% endif %}
      </p>

      <p>
        Color:{% if product.color %}
          {{ product.color }}
        {% else %}
          N/A
        {% endif %}
      </p>

      <p>
        Stock:{% if product.stock > 0 %}
          {{ product.stock }} in stock
        {% else %}
          <span style="color:red">Out of stock</span>
        {% endif %}
      </p>

      {% comment %} {% url 'add_to_cart' product.id %}this to be placed to action when view is ready{% endcomment %}
      {% comment %} {% csrf_token %} {% endcomment %}
      <label for="quantity">Quantity:</label>
      <input type="number" id="quantity" name="quantity" min="1" max="{{ product.stock }}" value="1" />

      <button type="submit" id="add-to-cart" value="{{ product.pk }}">Add to Cart</button>

      <hr class="horizontal-rule" />

      <h2>Customer Reviews</h2>
      {% if reviews %}
        <ul>
          {% for review in reviews %}
            <li class="review-item">
              <p class="col-span-2">
                <span class="px-2 font-bold bg-red-600 rounded-lg">{{ review.rating }}</span> out of 5 stars - <br />{{ review.comment }}
              </p>
              <small>By: {{ review.user.username }}</small>
              <small>Posted on: {{ review.created_at }}</small>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No reviews yet.</p>
      {% endif %}

      {% if user.is_authenticated %}
        <form method="post" action="{% url 'add_review' product.pk %}">
          {% csrf_token %}
          <label for="rating">Rating:</label>
          <select id="rating" name="rating">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5" selected>5</option>
          </select>

          <label for="comment">Comment:</label>
          <textarea id="comment" name="comment"></textarea>

          <button type="submit">Submit Review</button>
        </form>
      {% else %}
        <p>Please log in to leave a review.</p>
      {% endif %}
    </div>
  </div>
  <script>
    $('#add-to-cart').on('click', function () {
      const product_id = $(this).val()
      const quantity = $('#quantity').val()
      // Send AJAX request to add product to cart
      $.ajax({
        type: 'POST',
        url: "{% url 'add_to_cart' %}",
        data: {
          product_id: product_id,
          quantity: quantity,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          // Update cart count on page
          $('.cart-len').text(response.cart_len)
    
          if ($('.message-container').length === 0) {
            // Create and append message-container div to header only if it doesn't exist
            $('header').append($('<div>', { class: 'message-container' }))
          }
          if ($('.message').length === 0) {
            // Create and append message div to message-container only if it doesn't exist
            $('.message-container').append($('<div>', { class: 'message', text:response.message }))
          } else {
            // Update existing message div with new message text
            $('.message').text(response.message)
          }
          // Show the message container, wait 3000ms, then fade out
          $('.message-container').show().delay(3000).fadeOut()
        },
        error: function () {
          alert('Error adding product to cart!')
        }
      })
    })
  </script>
{% endblock %}
